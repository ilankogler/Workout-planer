
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Half Marathon Planner</title>
<style>
  :root {
    --easy:#a8e6a3; --speed:#87ceeb; --long:#ffcc80; --race:#ff9999; --rest:#cccccc; --runwalk:#b3a2c7; --walk:#f4cccc;
    --bg:#0f1115; --card:#171923; --text:#e9edf1; --muted:#a0aec0; --accent:#52c7ea; --danger:#ff6b6b; --ok:#52dea6;
  }
  * { box-sizing: border-box; }
  body { margin:0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text);}
  header { position:sticky; top:0; backdrop-filter: blur(8px); background:rgba(15,17,21,.85); padding:12px 16px; border-bottom:1px solid #2d3748; z-index:10; display:flex; align-items:center; gap:10px; justify-content:space-between;}
  h1 { margin:0; font-size:18px; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  select, button, input[type="file"], input, textarea{ background:#1f2330; color:var(--text); border:1px solid #2d3748; border-radius:10px; padding:10px 12px; font-size:14px; }
  button.primary{ background:var(--accent); color:#00202a; border:none; }
  button.ghost{ background:transparent; border:1px solid #2d3748; }
  .progress { margin:12px 16px; background:#1f2330; border-radius:12px; padding:12px; }
  .bar-wrap { height:10px; background:#2d3748; border-radius:8px; overflow:hidden; }
  .bar { height:100%; width:0%; background:linear-gradient(90deg, #52c7ea, #8be9fd); transition: width .3s ease; }
  .statline { display:flex; justify-content:space-between; font-size:13px; color:var(--muted); margin-top:8px; }
  .list { display:grid; gap:10px; padding:10px 16px 120px; }
  .card { background:var(--card); border:1px solid #2d3748; padding:12px; border-radius:12px; display:grid; grid-template-columns:auto 1fr; gap:12px; align-items:center; }
  .meta { font-size:12px; color:var(--muted); }
  .workout { font-weight:600; }
  .pill { font-size:11px; padding:4px 8px; border-radius:999px; color:#0b0e10; width:max-content; }
  .type-e { background:var(--easy); }
  .type-s { background:var(--speed); }
  .type-l { background:var(--long); }
  .type-race { background:var(--race); }
  .type-rest { background:var(--rest); }
  .type-runwalk { background:var(--runwalk); color:#191919; }
  .type-walk { background:var(--walk); color:#191919; }
  input[type=checkbox]{ width:22px; height:22px; accent-color: #52c7ea; }
  details { grid-column:1 / -1; }
  textarea, input.note { width:100%; background:#0f1115; color:var(--text); border:1px solid #2d3748; border-radius:8px; padding:8px; font-size:14px; }
  footer.fixed { position:fixed; bottom:0; left:0; right:0; background:rgba(15,17,21,.95); border-top:1px solid #2d3748; padding:10px 16px; display:flex; gap:8px; flex-wrap:wrap;}
  .badge { font-size:12px; color:var(--muted); }
  .next { background:#12202a; border:1px solid #244b57; border-radius:12px; padding:10px 12px; margin:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px;}
  .next strong{ color:#9be7ff; }
  .hidden { display:none !important; }
  /* Modal */
  .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(4,8,12,.65); z-index:100;}
  .sheet { width:min(680px, 94vw); max-height:90vh; overflow:auto; background:#0f1115; border:1px solid #2d3748; border-radius:16px; padding:16px; }
  .grid { display:grid; gap:10px; }
  .two { grid-template-columns: 1fr 1fr; }
  label { font-size:13px; color:#cbd5e0; }
  .row { display:grid; gap:6px; }
  .danger { color:var(--danger); }
  .ok { color:var(--ok); }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px;">
    <h1>Half Marathon Planner</h1>
    <span class="badge" id="userBadge">Guest</span>
  </div>
  <div class="controls">
    <select id="weekFilter"></select>
    <button id="showAll" class="ghost">Show all</button>
    <button id="markWeek" class="primary">Mark week done</button>
    <button id="resetPlan" class="ghost">Reset & Replan</button>
    <button id="signin" class="primary">Sign in</button>
    <button id="signout" class="ghost hidden">Sign out</button>
  </div>
</header>

<section class="next hidden" id="nextBox">
  <div id="nextText">Next workout:</div>
  <button id="markNext" class="primary">Mark next as done</button>
</section>

<section class="progress">
  <div class="bar-wrap"><div class="bar" id="bar"></div></div>
  <div class="statline">
    <div><span id="doneCount">0</span>/<span id="totalCount">0</span> completed</div>
    <div id="percent">0%</div>
  </div>
</section>

<main class="list" id="list"></main>

<footer class="fixed">
  <button id="export" class="primary">Export progress</button>
  <input id="importFile" type="file" accept="application/json"/>
  <button id="importBtn">Import</button>
  <button id="installBtn">Add to Home</button>
</footer>

<!-- Onboarding Modal -->
<div class="modal" id="onboardModal" role="dialog" aria-modal="true">
  <div class="sheet">
    <h2 style="margin:0 0 8px 0;">Welcome üëã</h2>
    <p style="margin-top:0;color:var(--muted)">Let's customize your plan. You can change this anytime.</p>
    <div class="grid">
      <div class="row">
        <label>What's the longest distance you can comfortably run today? (km)</label>
        <input id="q_longest" type="number" min="0" step="0.1" placeholder="e.g., 3">
      </div>
      <div class="row">
        <label>How fast can you currently run 3 km? (mm:ss)</label>
        <input id="q_3k" type="text" placeholder="e.g., 18:00">
      </div>
      <div class="row">
        <label>Your goal</label>
        <select id="q_goal">
          <option value="health">General health / casual running</option>
          <option value="distance">Run a specific distance</option>
          <option value="time">Run a distance under a target time</option>
        </select>
      </div>
      <div class="grid two" id="goalExtra" style="display:none;">
        <div class="row">
          <label>Target distance (km)</label>
          <input id="q_target_km" type="number" step="0.1" placeholder="e.g., 21.1">
        </div>
        <div class="row">
          <label>Target time (mm:ss) ‚Äî optional unless time goal</label>
          <input id="q_target_time" type="text" placeholder="e.g., 01:59:00 for HM">
        </div>
        <div class="row" style="grid-column:1/-1;">
          <label>Do you have a specific target date?</label>
          <input id="q_target_date" type="date">
        </div>
      </div>
      <div class="row">
        <label>Start training from date</label>
        <input id="q_start" type="date">
      </div>
      <div class="row">
        <label>How many run days per week?</label>
        <select id="q_days">
          <option value="3">3</option>
          <option value="4" selected>4</option>
        </select>
      </div>
      <div class="row">
        <small class="ok">Tip: You can re-open this wizard any time with ‚ÄúReset & Replan‚Äù.</small>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:6px;">
        <button id="cancelOnboard" class="ghost">Cancel</button>
        <button id="saveOnboard" class="primary">Create my plan</button>
      </div>
    </div>
  </div>
</div>
<script type="module">
  // Firebase JS SDK (modular)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getAuth, GoogleAuthProvider, onAuthStateChanged, 
    signInWithRedirect, getRedirectResult, signOut 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // OPTIONAL: Firestore (if you want cloud sync now; see Section 6)
  // import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const FIREBASE_ENABLED = true;
  const firebaseConfig = {
  apiKey: "AIzaSyCsk8uKyjaRUVih6HGUsPpwSUX_VI4bZwk",
  authDomain: "workout-planer-cd10f.firebaseapp.com",
  projectId: "workout-planer-cd10f",
  storageBucket: "workout-planer-cd10f.firebasestorage.app",
  messagingSenderId: "450896422196",
  appId: "1:450896422196:web:0b3f45b17b62881ee9f161"
};

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  provider.setCustomParameters({ prompt: 'select_account' }); // choose account

  // UI elements
  const signinBtn  = document.getElementById('signin');
  const signoutBtn = document.getElementById('signout');
  const userBadge  = document.getElementById('userBadge');

  // Local per-user storage helpers
  const LS_PREFIX = "hmx_";
  const lsKey = (uid, k) => `${LS_PREFIX}${uid}_${k}`;

  // Redirect result (after returning from Google)
  getRedirectResult(auth).catch(console.error);

  // Auth state listener
  onAuthStateChanged(auth, (user) => {
    if (user) {
      userBadge.textContent = user.displayName || "User";
      signinBtn.classList.add('hidden');
      signoutBtn.classList.remove('hidden');

      // Set ‚ÄúcurrentUser‚Äù globally if your app expects it:
      window.CURRENT_UID = user.uid;

      // If this user has no profile locally, force onboarding
      const profile = localStorage.getItem(lsKey(user.uid, "profile"));
      if (!profile) {
        // Clear any old guest state and open wizard
        localStorage.setItem(lsKey(user.uid, "state"), JSON.stringify({}));
        // Your existing openOnboarding() from Stage 1:
        window.openOnboarding?.(true);
      } else {
        // Build plan for this user
        window.buildPlanAndRender?.();
      }
    } else {
      // Guest mode
      userBadge.textContent = "Guest";
      signinBtn.classList.remove('hidden');
      signoutBtn.classList.add('hidden');
      window.CURRENT_UID = "local";

      // If no guest profile ‚Üí onboarding
      const gp = localStorage.getItem(lsKey("local", "profile"));
      if (!gp) window.openOnboarding?.(); else window.buildPlanAndRender?.();
    }
  });

  // Buttons
  signinBtn?.addEventListener('click', () => {
    signInWithRedirect(auth, provider);
  });

  signoutBtn?.addEventListener('click', async () => {
    // Optional: keep each user‚Äôs data in localStorage (we‚Äôre not deleting here).
    await signOut(auth);
    // Return to guest mode
    location.reload();
  });

  // Expose helpers for your existing functions to use the UID-aware keys
  window.getUID = () => (window.CURRENT_UID || "local");
  window.lsGet = (k) => localStorage.getItem(lsKey(window.getUID(), k));
  window.lsSet = (k, v) => localStorage.setItem(lsKey(window.getUID(), k), v);
</script>

<script>
/* =====================
   Minimal "multi-user" state via Firebase (optional) + localStorage fallback
   ===================== */
const FIREBASE_ENABLED = false; // set to true after adding your Firebase config below
// Paste your Firebase config here if you enable it:
const FIREBASE_CONFIG = {
  // apiKey: "...",
  // authDomain: "...",
  // projectId: "...",
  // storageBucket: "...",
  // messagingSenderId: "...",
  // appId: "..."
};

let currentUser = { uid: "local", displayName: "Guest" }; // fallback
const LS_PREFIX = "hmx_";
function lsKey(k){ return LS_PREFIX + (currentUser?.uid || "local") + "_" + k; }

/* =====================
   Utilities
   ===================== */
function parseTimeToMinutes(str){
  if(!str) return null;
  const parts = str.split(":").map(x=>parseInt(x,10));
  if(parts.length === 3){ return parts[0]*60 + parts[1] + (parts[2]/60); } // hh:mm:ss
  if(parts.length === 2){ return parts[0] + (parts[1]/60); } // mm:ss
  if(parts.length === 1){ return parseFloat(parts[0]); } // minutes
  return null;
}
function formatDate(d){ return d.toISOString().slice(0,10); }

/* =====================
   Planner "AI" stub + heuristic engine
   ===================== */
async function callPlannerAI(profile){
  // Stub: If you later wire to an API, return the same shape this function currently returns.
  return generatePlan(profile);
}

function generatePlan(profile){
  // Heuristic: foundation weeks depend on current longest run and 3k time
  const startDate = new Date(profile.startDate);
  const runDays = (profile.daysPerWeek||4)==4?["Mon","Wed","Sat","Sun"]:["Tue","Thu","Sat"];
  const weeks = [];
  const start3kMin = parseTimeToMinutes(profile.recent3k) || 18;
  const baseLongest = Math.max(2.5, parseFloat(profile.longestKm||3));

  const needFoundation = baseLongest < 4 || start3kMin >= 18;
  const foundationWeeks = needFoundation ? 4 : 0;

  // Build foundation phase (up to 4 weeks)
  for(let w=0; w<foundationWeeks; w++){
    const long = baseLongest + w*0.5 + 0.5;
    const wk = weekTemplate(runDays);
    wk.week = w - (foundationWeeks-1);
    wk.sessions = [
      {type:"E", text:`E: ${Math.max(2.5, Math.round((baseLongest + w*0.5)*10)/10)} km`},
      {type:"Run/Walk", text:`Run/Walk 5√ó(2-3 min run / 1 min walk)`},
      {type:"L", text:`L: ${Math.round(long*10)/10} km`},
      {type:"Walk", text:`Walk 30‚Äì40 min`},
    ];
    weeks.push(wk);
  }

  // Determine main plan length
  let totalWeeks = 16;
  if(profile.goalType!=="health" && profile.targetDate){
    const today = new Date(profile.startDate);
    const tdate = new Date(profile.targetDate);
    const diffWeeks = Math.max(8, Math.round((tdate - today)/(1000*60*60*24*7)));
    totalWeeks = Math.min(24, Math.max(12, diffWeeks)); // 12‚Äì24 weeks bound
  }

  // Build progressive plan
  let e=3, l=4; // starting easy, long
  const speedMenu = [
    "S: 4√ó400m fast / 400m jog",
    "S: 5√ó400m",
    "S: 4√ó600m",
    "S: 6√ó400m",
    "S: 5√ó600m",
    "S: 6√ó500m",
    "S: 4√ó800m",
    "S: 5√ó800m",
    "S: 6√ó800m",
    "S: 5√ó1 km",
    "S: 6√ó1 km",
    "S: 8√ó600m"
  ];
  let sp=0;
  const mainWeeks = totalWeeks;
  for(let w=1; w<=mainWeeks; w++){
    const wk = weekTemplate(runDays);
    wk.week = w;
    const S = speedMenu[Math.min(sp, speedMenu.length-1)];
    if(w%1===0) e = e + (w%2===0?0.5:0); // grow easy slowly
    if(w>1 && w<=14) l += (w%2===0?1:0); // long run increases ~ every other week until ~18km

    wk.sessions = [
      {type:"E", text:`E: ${round1(e)} km`},
      {type:"S", text:S},
      {type:"L", text:`L: ${Math.min(round1(l), profile.goalKm?Math.max(12, profile.goalKm*0.85):18)} km`},
      {type:"E", text:`E: ${round1(Math.max(3, e-1))} km`},
    ];
    weeks.push(wk);
    sp++;
  }

  // Taper in last 2 weeks if goal is distance/time
  if(profile.goalType!=="health"){
    const last = weeks.filter(w=>w.week>0).slice(-2);
    if(last.length===2){
      last[0].sessions[0].text = "E: 6 km";
      last[0].sessions[2].text = "L: 12 km";
      last[1].sessions = [
        {type:"E", text:"E: 4 km"},
        {type:"S", text:"S: 4√ó400m"},
        {type:"Rest", text:"Rest"},
        {type:"Race", text:`Race: ${profile.goalKm||21.1} km`},
      ];
    }
  }

  // Place sessions on dates
  const items = [];
  let anchor = new Date(startDate);
  const dayOffsets = { "Mon":0,"Tue":1,"Wed":2,"Thu":3,"Fri":4,"Sat":5,"Sun":6 };
  weeks.forEach(wk=>{
    runDays.slice(0,wk.sessions.length).forEach((day, i)=>{
      const session = wk.sessions[i];
      const d = new Date(anchor); d.setDate(anchor.getDate() + dayOffsets[day]);
      items.push({ week: wk.week, day, date: formatDate(d), workout: session.text });
    });
    anchor.setDate(anchor.getDate()+7);
  });

  return { items, runDays };
}

function weekTemplate(days){ return { week: 0, sessions: [], days }; }
function round1(x){ return Math.round(x*10)/10; }

/* =====================
   Rendering and state
   ===================== */
function getProfile(){
  try { return JSON.parse(window.lsGet("profile")); } catch(e){ return null; }
}
function setProfile(p){
  window.lsSet("profile", JSON.stringify(p));
}
function getState(){ 
  try { return JSON.parse(window.lsGet("state")) || {}; } catch(e){ return {}; } 
}
function setState(s){ window.lsSet("state", JSON.stringify(s)); }

function typeFromText(t) {
  if (t.startsWith("E:")) return "e";
  if (t.startsWith("S:")) return "s";
  if (t.startsWith("L:")) return "l";
  if (t.includes("Race")) return "race";
  if (t.includes("Rest")) return "rest";
  if (t.includes("Run/Walk")) return "runwalk";
  if (t.includes("Walk")) return "walk";
  return "e";
}

let PLAN = { data: [] };
async function buildPlanAndRender(){
  const prof = getProfile();
  if(!prof){ openOnboarding(); return; }
  PLAN = await callPlannerAI(prof);
  renderList();
}

function renderList(){
  const list = document.getElementById('list');
  list.innerHTML = "";
  const state = getState();
  const weeks = [...new Set(PLAN.items.map(i=>i.week))].sort((a,b)=>a-b);
  const weekFilter = document.getElementById('weekFilter');
  weekFilter.innerHTML = weeks.map(w=>`<option value="${w}">Week ${w}</option>`).join("");
  if(state.filterWeek==null) state.filterWeek = weeks[0];
  weekFilter.value = state.filterWeek;
  const total = PLAN.items.length;
  document.getElementById('totalCount').textContent = total;

  // Next workout banner
  const today = new Date().toISOString().slice(0,10);
  const next = PLAN.items.find(i=>!state["w"+PLAN.items.indexOf(i)] && i.date >= today);
  const nextBox = document.getElementById('nextBox');
  if(next){
    nextBox.classList.remove("hidden");
    document.getElementById('nextText').innerHTML = `Next workout: <strong>${next.workout}</strong> ‚Ä¢ ${next.day} ‚Ä¢ ${next.date}`;
    document.getElementById('markNext').onclick = ()=>{
      const idx = PLAN.items.indexOf(next);
      state["w"+idx] = true; setState(state); updateProgress(); renderList();
    };
  } else { nextBox.classList.add("hidden"); }

  PLAN.items.forEach((it, idx)=>{
    const show = (state.filterWeek==null || it.week == state.filterWeek);
    const card = document.createElement('div');
    card.className = 'card';
    if(!show) card.style.display = 'none';

    const id = "w"+idx;
    const cb = document.createElement('input');
    cb.type = 'checkbox'; cb.checked = !!state[id];
    cb.addEventListener('change', ()=>{ state[id]=cb.checked; setState(state); updateProgress(); });

    const content = document.createElement('div');
    const wline = document.createElement('div'); wline.className = 'workout'; wline.textContent = it.workout;
    const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = `Week ${it.week} ‚Ä¢ ${it.day} ‚Ä¢ ${it.date}`;
    const pill = document.createElement('span'); const type = typeFromText(it.workout); pill.className='pill type-'+type; pill.textContent=type.toUpperCase();

    const details = document.createElement('details');
    const summary = document.createElement('summary'); summary.textContent='Add notes';
    const fields = document.createElement('div');
    fields.innerHTML = `
      <div style="display:grid; gap:8px; margin-top:8px;">
        <input class="note" id="time_${id}" placeholder="Time (min)" inputmode="decimal">
        <input class="note" id="dist_${id}" placeholder="Distance (km)" inputmode="decimal">
        <input class="note" id="hr_${id}" placeholder="Avg HR">
        <textarea class="note" id="notes_${id}" rows="2" placeholder="Notes"></textarea>
      </div>`;

    ["time_","dist_","hr_","notes_"].forEach(k=>{
      const el = fields.querySelector("#"+k+id);
      if(state[k+id]) el.value = state[k+id];
      el.addEventListener('input', ()=>{ state[k+id]=el.value; setState(state); });
    });

    details.appendChild(summary); details.appendChild(fields);
    content.appendChild(wline); content.appendChild(meta); content.appendChild(pill); content.appendChild(details);
    card.appendChild(cb); card.appendChild(content);
    list.appendChild(card);
  });

  updateProgress();
  hookControls();
}

function updateProgress(){
  const state = getState();
  const total = PLAN.items.length;
  let done = 0;
  PLAN.items.forEach((_, idx)=>{ if (state['w'+idx]) done++; });
  const pct = total ? Math.round(done*100/total) : 0;
  document.getElementById('doneCount').textContent = done;
  document.getElementById('percent').textContent = pct + "%";
  document.getElementById('bar').style.width = pct + "%";
}

/* =====================
   Controls
   ===================== */
function hookControls(){
  const state = getState();
  document.getElementById('weekFilter').onchange = (e)=>{ state.filterWeek=parseInt(e.target.value); setState(state); renderList(); };
  document.getElementById('showAll').onclick = ()=>{ state.filterWeek=null; setState(state); renderList(); };
  document.getElementById('markWeek').onclick = ()=>{
    if(state.filterWeek==null) return;
    PLAN.items.forEach((it, idx)=>{ if (it.week===state.filterWeek) state['w'+idx]=true; });
    setState(state); renderList();
  };
  document.getElementById('resetPlan').onclick = ()=>{ openOnboarding(true); };

  document.getElementById('export').onclick = ()=>{
    const blob = new Blob([JSON.stringify({profile:getProfile(), state:getState()}, null, 2)], {type:"application/json"});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'hm_backup.json'; a.click();
  };
  document.getElementById('importBtn').onclick = ()=>{
    const f = document.getElementById('importFile').files[0]; if(!f) return;
    const r = new FileReader(); r.onload = ()=>{ try{ const o=JSON.parse(r.result); if(o.profile) setProfile(o.profile); if(o.state) setState(o.state); buildPlanAndRender(); }catch(e){ alert('Invalid file'); } }; r.readAsText(f);
  };

  // PWA-ish
  let deferredPrompt=null;
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; document.getElementById('installBtn').disabled=false; });
  document.getElementById('installBtn').onclick = async ()=>{
    if(!deferredPrompt){ alert('Use Share ‚Üí Add to Home Screen'); return; } deferredPrompt.prompt(); deferredPrompt=null;
  };
}

/* =====================
   Onboarding modal
   ===================== */
function openOnboarding(isReset=false){
  const m = document.getElementById('onboardModal'); m.style.display='flex';
  const qgoal = document.getElementById('q_goal');
  const extra = document.getElementById('goalExtra');
  qgoal.onchange = ()=>{ extra.style.display = (qgoal.value==="distance"||qgoal.value==="time")?"grid":"none"; };
  const start = document.getElementById('q_start'); if(!start.value){ start.value = new Date().toISOString().slice(0,10); }
  document.getElementById('cancelOnboard').onclick = ()=>{ if(isReset){ m.style.display='none'; } else { /* new user must complete */ alert('Please complete setup to continue.'); } };
  document.getElementById('saveOnboard').onclick = ()=>{
    const p = {
      longestKm: parseFloat(document.getElementById('q_longest').value||"3"),
      recent3k: document.getElementById('q_3k').value||"18:00",
      goalType: qgoal.value,
      targetKm: parseFloat(document.getElementById('q_target_km').value||"0"),
      targetTime: document.getElementById('q_target_time').value||"",
      targetDate: document.getElementById('q_target_date').value||"",
      startDate: document.getElementById('q_start').value || new Date().toISOString().slice(0,10),
      daysPerWeek: parseInt(document.getElementById('q_days').value||"4",10),
    };
    if(p.goalType!=="health"){ p.goalKm = p.targetKm || 21.1; } else { p.goalKm = null; }
    setProfile(p);
    setState({}); // reset progress
    m.style.display='none';
    buildPlanAndRender();
  };
}

/* =====================
   Firebase Auth scaffolding (Stage 2)
   ===================== */
async function initFirebaseIfEnabled(){
  if(!FIREBASE_ENABLED) { document.getElementById('signin').classList.add('hidden'); return; }
  // Load Firebase scripts
  const s1 = document.createElement('script'); s1.src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js";
  const s2 = document.createElement('script'); s2.src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js";
  document.head.appendChild(s1); document.head.appendChild(s2);
  await new Promise(res=>s2.onload=res);
  // Initialize
  firebase.initializeApp(FIREBASE_CONFIG);
  const auth = firebase.auth();
  const provider = new firebase.auth.GoogleAuthProvider();

  auth.onAuthStateChanged((user)=>{
    if(user){ currentUser = { uid:user.uid, displayName:user.displayName||"User" }; document.getElementById('userBadge').textContent = currentUser.displayName; 
      document.getElementById('signin').classList.add('hidden'); document.getElementById('signout').classList.remove('hidden');
      // New user ‚Üí force onboarding
      if(!getProfile()) openOnboarding();
      else buildPlanAndRender();
    }else{
      currentUser = { uid:"local", displayName:"Guest" };
      document.getElementById('userBadge').textContent = "Guest";
      document.getElementById('signin').classList.remove('hidden'); document.getElementById('signout').classList.add('hidden');
      if(!getProfile()) openOnboarding(); else buildPlanAndRender();
    }
  });

  document.getElementById('signin').onclick = ()=>auth.signInWithPopup(provider);
  document.getElementById('signout').onclick = ()=>{ auth.signOut(); localStorage.clear(); location.reload(); };
}

/* =====================
   Boot
   ===================== */
document.getElementById('signin').classList.add(FIREBASE_ENABLED?'':'hidden');
document.getElementById('signout').classList.add('hidden');
initFirebaseIfEnabled();
if(!FIREBASE_ENABLED){
  // Guest mode
  if(!getProfile()) openOnboarding(); else buildPlanAndRender();
}
</script>
</body>
</html>
