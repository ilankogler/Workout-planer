<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Half Marathon Planner</title>
<style>
  :root{
    --easy:#a8e6a3; --speed:#87ceeb; --long:#ffcc80; --race:#ff9999; --rest:#cccccc; --runwalk:#b3a2c7; --walk:#f4cccc;
    --bg:#0f1115; --card:#171923; --text:#e9edf1; --muted:#a0aec0; --accent:#52c7ea; --danger:#ff6b6b;
  }
  *{box-sizing:border-box} body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;backdrop-filter:blur(8px);background:rgba(15,17,21,.85);padding:12px 16px;border-bottom:1px solid #2d3748;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:10px}
  h1{margin:0;font-size:18px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,button,input,textarea{background:#1f2330;color:var(--text);border:1px solid #2d3748;border-radius:10px;padding:10px 12px;font-size:14px}
  button.primary{background:var(--accent);color:#00202a;border:none}
  button.ghost{background:transparent;border:1px solid #2d3748}
  .badge{font-size:12px;color:var(--muted)}
  .banner{padding:10px 16px;background:#1f2330;border-bottom:1px solid #2d3748;color:var(--muted)}
  .progress{margin:12px 16px;background:#1f2330;border-radius:12px;padding:12px}
  .bar-wrap{height:10px;background:#2d3748;border-radius:8px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#52c7ea,#8be9fd);transition:width .3s ease}
  .statline{display:flex;justify-content:space-between;font-size:13px;color:var(--muted);margin-top:8px}
  .list{display:grid;gap:10px;padding:10px 16px 120px}
  .card{background:var(--card);border:1px solid #2d3748;padding:12px;border-radius:12px;display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center}
  .meta{font-size:12px;color:var(--muted)} .workout{font-weight:600}
  .pill{font-size:11px;padding:4px 8px;border-radius:999px;color:#0b0e10;width:max-content}
  .type-e{background:var(--easy)} .type-s{background:var(--speed)} .type-l{background:var(--long)}
  .type-race{background:var(--race)} .type-rest{background:var(--rest)} .type-runwalk{background:var(--runwalk);color:#191919} .type-walk{background:var(--walk);color:#191919}
  input[type=checkbox]{width:22px;height:22px;accent-color:#52c7ea}
  details{grid-column:1 / -1}
  textarea,input.note{width:100%;background:#0f1115;color:#e9edf1;border:1px solid #2d3748;border-radius:8px;padding:8px;font-size:14px}
  footer.fixed{position:fixed;bottom:0;left:0;right:0;background:rgba(15,17,21,.95);border-top:1px solid #2d3748;padding:10px 16px;display:flex;gap:8px;flex-wrap:wrap}
  .next{background:#12202a;border:1px solid #244b57;border-radius:12px;padding:10px 12px;margin:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .next strong{color:#9be7ff}
  .hidden{display:none !important}

  /* Login gate */
  .gate{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
  .panel{width:min(520px,94vw);background:#0f1115;border:1px solid #2d3748;border-radius:16px;padding:20px;display:grid;gap:12px}
  .row{display:grid;gap:6px}
  .note{color:#a0aec0;font-size:12px}
  .stack{display:grid;gap:8px}
  .inline{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>

<!-- ---------- LOGIN GATE ---------- -->
<section id="loginGate" class="gate">
  <div class="panel">
    <h2 style="margin:0 0 6px 0;">Welcome ðŸ‘‹</h2>
    <p class="note" style="margin-top:0">Sign in to create and sync your plan. Your data is saved to your account.</p>

    <div class="stack">
      <button id="loginGoogle" class="primary">Continue with Google</button>

      <div style="height:1px;background:#2d3748;margin:8px 0"></div>

      <div class="row">
        <label for="phoneInput">Phone number (E.164, e.g. +972501234567)</label>
        <input id="phoneInput" type="tel" placeholder="+972..." inputmode="tel"/>
        <div id="recaptcha-container"></div>
        <div class="inline">
          <button id="sendCode" class="ghost">Send code</button>
          <span id="sendMsg" class="note"></span>
        </div>
      </div>

      <div class="row">
        <label for="codeInput">Verification code (SMS)</label>
        <input id="codeInput" type="text" placeholder="123456" inputmode="numeric" />
        <div class="inline">
          <button id="verifyCode" class="primary">Verify & Sign in</button>
          <span id="verifyMsg" class="note"></span>
        </div>
      </div>
    </div>

    <div id="loginMsg" class="note"></div>

    <div style="height:1px;background:#2d3748;margin:8px 0"></div>

    <button id="continueGuest" class="ghost">Continue as Guest (local only)</button>
  </div>
</section>

<!-- ---------- APP (hidden until signed in / guest) ---------- -->
<header id="appHeader" class="hidden">
  <div style="display:flex;align-items:center;gap:10px;">
    <h1>Half Marathon Planner</h1>
    <span class="badge" id="userBadge">Guest</span>
  </div>
  <div class="controls">
    <select id="weekFilter"></select>
    <button id="showAll" class="ghost">Show all</button>
    <button id="markWeek" class="primary">Mark week done</button>
    <button id="resetPlan" class="ghost">Reset & Replan</button>
    <button id="signout" class="ghost hidden">Sign out</button>
  </div>
</header>

<div id="banner" class="banner hidden"></div>

<section id="nextBox" class="next hidden">
  <div id="nextText">Next workout:</div>
  <button id="markNext" class="primary">Mark next as done</button>
</section>

<section class="progress hidden" id="progressWrap">
  <div class="bar-wrap"><div class="bar" id="bar"></div></div>
  <div class="statline">
    <div><span id="doneCount">0</span>/<span id="totalCount">0</span> completed</div>
    <div id="percent">0%</div>
  </div>
</section>

<main class="list hidden" id="list"></main>

<footer class="fixed hidden" id="footer">
  <button id="export" class="primary">Export progress</button>
  <input id="importFile" type="file" accept="application/json"/>
  <button id="importBtn">Import</button>
  <button id="installBtn">Add to Home</button>
</footer>

<!-- Onboarding Modal -->
<div class="modal hidden" id="onboardModal" role="dialog" aria-modal="true">
  <div class="sheet">
    <h2 style="margin:0 0 8px 0;">Letâ€™s customize your plan</h2>
    <p style="margin-top:0;color:var(--muted)">You can change this anytime.</p>
    <div class="grid">
      <div class="row">
        <label>Longest distance you can run today (km)</label>
        <input id="q_longest" type="number" min="0" step="0.1" placeholder="e.g., 3">
      </div>
      <div class="row">
        <label>Current 3 km time (mm:ss)</label>
        <input id="q_3k" type="text" placeholder="e.g., 18:00">
      </div>
      <div class="row">
        <label>Your goal</label>
        <select id="q_goal">
          <option value="health">General health / casual</option>
          <option value="distance">Run a specific distance</option>
          <option value="time">Run a distance under a target time</option>
        </select>
      </div>
      <div class="grid two" id="goalExtra" style="display:none;">
        <div class="row">
          <label>Target distance (km)</label>
          <input id="q_target_km" type="number" step="0.1" placeholder="e.g., 21.1">
        </div>
        <div class="row">
          <label>Target time (hh:mm:ss) â€” optional unless time goal</label>
          <input id="q_target_time" type="text" placeholder="e.g., 01:59:00">
        </div>
        <div class="row" style="grid-column:1/-1;">
          <label>Target date (optional)</label>
          <input id="q_target_date" type="date">
        </div>
      </div>
      <div class="row">
        <label>Start date</label>
        <input id="q_start" type="date">
      </div>
      <div class="row">
        <label>Run days per week</label>
        <select id="q_days">
          <option value="3">3</option>
          <option value="4" selected>4</option>
        </select>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:6px;">
        <button id="cancelOnboard" class="ghost">Cancel</button>
        <button id="saveOnboard" class="primary">Create my plan</button>
      </div>
    </div>
  </div>
</div>

<!-- ========== Firebase (modular) + App code ========== -->
<script type="module">
  /********** 1) CONFIGURE FIREBASE HERE **********/
  const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCsk8uKyjaRUVih6HGUsPpwSUX_VI4bZwk",
  authDomain: "workout-planer-cd10f.firebaseapp.com",
  projectId: "workout-planer-cd10f",
  storageBucket: "workout-planer-cd10f.firebasestorage.app",
  messagingSenderId: "450896422196",
  appId: "1:450896422196:web:0b3f45b17b62881ee9f161"
  };
  const HAS_CONFIG = FIREBASE_CONFIG.apiKey && !FIREBASE_CONFIG.apiKey.startsWith("YOUR_");

  // Firebase imports (modular)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getAuth, GoogleAuthProvider, RecaptchaVerifier,
    onAuthStateChanged, signInWithRedirect, getRedirectResult, signOut, signInWithPhoneNumber
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // UI elements
  const loginGate = document.getElementById('loginGate');
  const loginGoogle = document.getElementById('loginGoogle');
  const continueGuest = document.getElementById('continueGuest');
  const loginMsg = document.getElementById('loginMsg');

  const phoneInput = document.getElementById('phoneInput');
  const sendCodeBtn = document.getElementById('sendCode');
  const codeInput = document.getElementById('codeInput');
  const verifyCodeBtn = document.getElementById('verifyCode');
  const sendMsg = document.getElementById('sendMsg');
  const verifyMsg = document.getElementById('verifyMsg');

  const appHeader = document.getElementById('appHeader');
  const banner = document.getElementById('banner');
  const nextBox = document.getElementById('nextBox');
  const nextText = document.getElementById('nextText');
  const markNext = document.getElementById('markNext');
  const progressWrap = document.getElementById('progressWrap');
  const list = document.getElementById('list');
  const footer = document.getElementById('footer');
  const userBadge = document.getElementById('userBadge');
  const signoutBtn = document.getElementById('signout');

  const weekFilter = document.getElementById('weekFilter');
  const showAll = document.getElementById('showAll');
  const markWeek = document.getElementById('markWeek');
  const resetPlan = document.getElementById('resetPlan');
  const exportBtn = document.getElementById('export');
  const importBtn = document.getElementById('importBtn');
  const importFile = document.getElementById('importFile');
  const installBtn = document.getElementById('installBtn');

  // Local cache helpers (per user)
  const LS = {
    key: (uid,k)=>`hmx_${uid||"local"}_${k}`,
    get:(uid,k)=>{ try{return JSON.parse(localStorage.getItem(LS.key(uid,k)))}catch{return null} },
    set:(uid,k,v)=>localStorage.setItem(LS.key(uid,k), JSON.stringify(v)),
  };

  let currentUser = null; // { uid, displayName }
  let PLAN = { items:[], runDays:[] };
  let db, auth, confirmationResult = null;

  function showAppUI(show){
    [appHeader, progressWrap, list, footer].forEach(el => el.classList.toggle('hidden', !show));
    loginGate.classList.toggle('hidden', show);
  }

  // Boot Firebase (or fall back to local guest)
  if (HAS_CONFIG) {
    const app = initializeApp(FIREBASE_CONFIG);
    auth = getAuth(app);
    db = getFirestore(app);

    // Google Provider
    const google = new GoogleAuthProvider();
    google.setCustomParameters({ prompt:'select_account' });

    // reCAPTCHA for phone
    let recaptchaVerifier;
    function ensureRecaptcha(){
      if (!recaptchaVerifier) {
        recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
          'size': 'invisible', // use 'normal' to show the widget if you prefer
        });
      }
      return recaptchaVerifier;
    }

    // Redirect result (after returning from Google)
    getRedirectResult(auth).catch(()=>{});

    // Click handlers
    loginGoogle.onclick = ()=> signInWithRedirect(auth, google);
    continueGuest.onclick = ()=> { currentUser = { uid:"local", displayName:"Guest" }; enterApp(); };

    sendCodeBtn.onclick = async () => {
      sendMsg.textContent = ""; verifyMsg.textContent = "";
      const phoneNumber = (phoneInput.value || "").trim();
      if(!phoneNumber.startsWith('+')) { sendMsg.textContent = "Use international format, e.g. +972..."; return; }
      try{
        const appVerifier = ensureRecaptcha();
        confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
        sendMsg.textContent = "Code sent. Check your SMS.";
      }catch(e){
        sendMsg.textContent = "Failed to send code: " + (e.message||e);
      }
    };

    verifyCodeBtn.onclick = async () => {
      verifyMsg.textContent = "";
      const code = (codeInput.value||"").trim();
      if(!confirmationResult) { verifyMsg.textContent = "Send the code first."; return; }
      try{
        const cred = await confirmationResult.confirm(code);
        // user signed in
      }catch(e){
        verifyMsg.textContent = "Invalid code. Try again.";
      }
    };

    // Auth listener
    onAuthStateChanged(auth, async (user)=>{
      if (user) {
        currentUser = { uid:user.uid, displayName:user.displayName || user.phoneNumber || user.email || "User" };
        await enterApp(true);
      } else {
        // show login gate
        showAppUI(false);
      }
    });

    signoutBtn.onclick = async ()=>{ await signOut(auth); location.reload(); };

  } else {
    // No Firebase config â†’ only Guest
    banner.classList.remove('hidden');
    banner.textContent = "Firebase not configured â€” using Guest mode (local only).";
    loginGoogle.disabled = true;
    sendCodeBtn.disabled = true;
    verifyCodeBtn.disabled = true;
    continueGuest.onclick = ()=>{ currentUser = { uid:"local", displayName:"Guest" }; enterApp(); };
  }

  /** Enter app (after auth or guest) */
  async function enterApp(isAuthed=false){
    userBadge.textContent = currentUser.displayName || "Guest";
    showAppUI(true);

    // Load profile/progress (cloud â†’ local)
    let profile = LS.get(currentUser.uid,'profile');
    let progress = LS.get(currentUser.uid,'progress') || {};

    if (db && isAuthed && currentUser.uid!=="local") {
      const profSnap = await getDoc(doc(db,"users",currentUser.uid,"profile","default"));
      if (profSnap.exists()) { profile = profSnap.data(); LS.set(currentUser.uid,'profile',profile); }
      const progSnap = await getDoc(doc(db,"users",currentUser.uid,"progress","current"));
      if (progSnap.exists()) { progress = progSnap.data(); LS.set(currentUser.uid,'progress',progress); }
    }

    if (!profile) {
      openOnboarding(); // new user
    } else {
      await buildPlanAndRender(profile, progress);
    }
  }

  /** ----- Planner / Generator ----- */
  function parseTimeToMinutes(str){
    if(!str) return null;
    const p = str.split(":").map(x=>parseInt(x,10));
    if(p.length===3) return p[0]*60+p[1]+p[2]/60;
    if(p.length===2) return p[0]+p[1]/60;
    return parseFloat(p[0]);
  }
  const round1 = x => Math.round(x*10)/10;
  const formatDate = d => d.toISOString().slice(0,10);

  function typeFromText(t){
    if (t.startsWith("E:")) return "e";
    if (t.startsWith("S:")) return "s";
    if (t.startsWith("L:")) return "l";
    if (t.includes("Race")) return "race";
    if (t.includes("Rest")) return "rest";
    if (t.includes("Run/Walk")) return "runwalk";
    if (t.includes("Walk")) return "walk";
    return "e";
  }

  async function callPlannerAI(profile){ return generatePlan(profile); } // stub
  function generatePlan(profile){
    const startDate = new Date(profile.startDate);
    const runDays = (profile.daysPerWeek||4)==4?["Mon","Wed","Sat","Sun"]:["Tue","Thu","Sat"];
    const items = [];
    const start3kMin = parseTimeToMinutes(profile.recent3k) || 18;
    const baseLongest = Math.max(2.5, parseFloat(profile.longestKm||3));
    const needFoundation = baseLongest < 4 || start3kMin >= 18;
    const foundationWeeks = needFoundation ? 4 : 0;

    let anchor = new Date(startDate);
    const dayOffsets = { "Mon":0,"Tue":1,"Wed":2,"Thu":3,"Fri":4,"Sat":5,"Sun":6 };

    for(let w=0; w<foundationWeeks; w++){
      const long = baseLongest + w*0.5 + 0.5;
      const sessions = [
        `E: ${round1(Math.max(2.5, baseLongest + w*0.5))} km`,
        `Run/Walk 5Ã—(2â€“3 min run / 1 min walk)`,
        `L: ${round1(long)} km`,
        `Walk 30â€“40 min`
      ];
      const weekNum = w - (foundationWeeks-1);
      runDays.slice(0,sessions.length).forEach((day,i)=>{
        const d = new Date(anchor); d.setDate(anchor.getDate()+dayOffsets[day]);
        items.push({ week: weekNum, day, date: formatDate(d), workout: sessions[i] });
      });
      anchor.setDate(anchor.getDate()+7);
    }

    let totalWeeks = 16;
    if(profile.goalType!=="health" && profile.targetDate){
      const tdate = new Date(profile.targetDate);
      const diffWeeks = Math.max(8, Math.round((tdate - startDate)/(1000*60*60*24*7)));
      totalWeeks = Math.min(24, Math.max(12, diffWeeks));
    }

    let e=3, l=4, sp=0;
    const speedMenu = ["S: 4Ã—400m fast / 400m jog","S: 5Ã—400m","S: 4Ã—600m","S: 6Ã—400m","S: 5Ã—600m","S: 6Ã—500m","S: 4Ã—800m","S: 5Ã—800m","S: 6Ã—800m","S: 5Ã—1 km","S: 6Ã—1 km","S: 8Ã—600m"];
    for(let w=1; w<=totalWeeks; w++){
      const S = speedMenu[Math.min(sp, speedMenu.length-1)];
      if(w%1===0) e += (w%2===0?0.5:0);
      if(w>1 && w<=14) l += (w%2===0?1:0);
      const sessions = [
        `E: ${round1(e)} km`,
        S,
        `L: ${Math.min(round1(l), profile.goalKm?Math.max(12, profile.goalKm*0.85):18)} km`,
        `E: ${round1(Math.max(3, e-1))} km`
      ];
      runDays.forEach((day,i)=>{
        const d = new Date(anchor); d.setDate(anchor.getDate()+dayOffsets[day]);
        items.push({ week: w, day, date: formatDate(d), workout: sessions[i] || "Rest" });
      });
      anchor.setDate(anchor.getDate()+7); sp++;
    }

    return { items, runDays };
  }

  async function buildPlanAndRender(profile, progress){
    if(!profile){ openOnboarding(); return; }
    const plan = await callPlannerAI(profile);
    PLAN = plan;
    renderList(progress || {});
  }

  function renderList(progress){
    list.innerHTML = "";
    const state = progress || {};
    const weeks = [...new Set(PLAN.items.map(i=>i.week))].sort((a,b)=>a-b);
    weekFilter.innerHTML = weeks.map(w=>`<option value="${w}">Week ${w}</option>`).join("");
    if(state.filterWeek==null) state.filterWeek = weeks[0];
    weekFilter.value = state.filterWeek;
    document.getElementById('totalCount').textContent = PLAN.items.length;

    const today = new Date().toISOString().slice(0,10);
    const next = PLAN.items.find((it, idx)=>!state['w'+idx] && it.date >= today);
    if(next){
      nextBox.classList.remove('hidden');
      nextText.innerHTML = `Next workout: <strong>${next.workout}</strong> â€¢ ${next.day} â€¢ ${next.date}`;
      markNext.onclick = ()=>{ const idx = PLAN.items.indexOf(next); state['w'+idx]=true; saveProgress(state); updateProgress(state); renderList(state); };
    } else { nextBox.classList.add('hidden'); }

    PLAN.items.forEach((it, idx)=>{
      const show = (state.filterWeek==null || it.week == state.filterWeek);
      const card = document.createElement('div'); card.className='card'; if(!show) card.style.display='none';
      const id = "w"+idx;

      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=!!state[id];
      cb.addEventListener('change', ()=>{ state[id]=cb.checked; saveProgress(state); updateProgress(state); });

      const content = document.createElement('div');
      const wline = document.createElement('div'); wline.className='workout'; wline.textContent=it.workout;
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `Week ${it.week} â€¢ ${it.day} â€¢ ${it.date}`;
      const pill = document.createElement('span'); const typ=typeFromText(it.workout); pill.className='pill type-'+typ; pill.textContent=typ.toUpperCase();

      const details = document.createElement('details'); const summary = document.createElement('summary'); summary.textContent='Add notes';
      const fields = document.createElement('div'); fields.innerHTML = `
        <div style="display:grid;gap:8px;margin-top:8px;">
          <input class="note" id="time_${id}" placeholder="Time (min)" inputmode="decimal">
          <input class="note" id="dist_${id}" placeholder="Distance (km)" inputmode="decimal">
          <input class="note" id="hr_${id}" placeholder="Avg HR">
          <textarea class="note" id="notes_${id}" rows="2" placeholder="Notes"></textarea>
        </div>`;
      ["time_","dist_","hr_","notes_"].forEach(k=>{
        const el = fields.querySelector("#"+k+id);
        if(state[k+id]) el.value = state[k+id];
        el.addEventListener('input', ()=>{ state[k+id]=el.value; saveProgress(state); });
      });

      details.appendChild(summary); details.appendChild(fields);
      content.appendChild(wline); content.appendChild(meta); content.appendChild(pill); content.appendChild(details);
      card.appendChild(cb); card.appendChild(content);
      list.appendChild(card);
    });

    updateProgress(state);
    hookControls(state);
    [appHeader, progressWrap, list, footer].forEach(el=>el.classList.remove('hidden'));
  }

  function updateProgress(state){
    let done=0; PLAN.items.forEach((_, idx)=>{ if(state['w'+idx]) done++; });
    const total = PLAN.items.length; const pct = total? Math.round(done*100/total) : 0;
    document.getElementById('doneCount').textContent = done;
    document.getElementById('percent').textContent = pct + "%";
    document.getElementById('bar').style.width = pct + "%";
  }

  function hookControls(state){
    weekFilter.onchange = e=>{ state.filterWeek=parseInt(e.target.value); saveProgress(state); renderList(state); };
    showAll.onclick = ()=>{ state.filterWeek=null; saveProgress(state); renderList(state); };
    markWeek.onclick = ()=>{ if(state.filterWeek==null) return; PLAN.items.forEach((it, idx)=>{ if (it.week===state.filterWeek) state['w'+idx]=true; }); saveProgress(state); renderList(state); };
    resetPlan.onclick = ()=> openOnboarding(true);

    exportBtn.onclick = ()=>{
      const blob = new Blob([JSON.stringify({profile:LS.get(currentUser.uid,'profile'), progress:LS.get(currentUser.uid,'progress')}, null, 2)], {type:"application/json"});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='hm_backup.json'; a.click();
    };
    importBtn.onclick = ()=>{
      const f = importFile.files[0]; if(!f) return;
      const r = new FileReader(); r.onload = async ()=>{
        try{
          const o = JSON.parse(r.result);
          if(o.profile){ await saveProfile(o.profile); }
          if(o.progress){ await saveProgress(o.progress); }
          await buildPlanAndRender(o.profile||LS.get(currentUser.uid,'profile'), o.progress||LS.get(currentUser.uid,'progress'));
        }catch{ alert('Invalid file'); }
      }; r.readAsText(f);
    };

    // PWA-ish
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.disabled=false; });
    installBtn.onclick = async ()=>{ if(!deferredPrompt){ alert('Use Share â†’ Add to Home Screen'); return; } deferredPrompt.prompt(); deferredPrompt=null; };
  }

  /** ----- Onboarding ----- */
  function openOnboarding(isReset=false){
    const m = document.getElementById('onboardModal'); m.classList.remove('hidden');
    const qgoal = document.getElementById('q_goal'); const extra = document.getElementById('goalExtra');
    qgoal.onchange = ()=>{ extra.style.display = (qgoal.value==="distance"||qgoal.value==="time")?"grid":"none"; };
    const start = document.getElementById('q_start'); if(!start.value){ start.value = new Date().toISOString().slice(0,10); }
    document.getElementById('cancelOnboard').onclick = ()=>{ if(isReset){ m.classList.add('hidden'); } else { alert('Please complete setup to continue.'); } };
    document.getElementById('saveOnboard').onclick = async ()=>{
      const p = {
        longestKm: parseFloat(document.getElementById('q_longest').value||"3"),
        recent3k: document.getElementById('q_3k').value||"18:00",
        goalType: qgoal.value,
        targetKm: parseFloat(document.getElementById('q_target_km').value||"0"),
        targetTime: document.getElementById('q_target_time').value||"",
        targetDate: document.getElementById('q_target_date').value||"",
        startDate: document.getElementById('q_start').value || new Date().toISOString().slice(0,10),
        daysPerWeek: parseInt(document.getElementById('q_days').value||"4",10),
      };
      if(p.goalType!=="health"){ p.goalKm = p.targetKm || 21.1; } else { p.goalKm = null; }
      await saveProfile(p);
      document.getElementById('onboardModal').classList.add('hidden');
      await buildPlanAndRender(p, LS.get(currentUser.uid,'progress')||{});
    };
  }

  /** ----- Cloud sync (Firestore) + local cache ----- */
  async function saveProfile(profile){
    LS.set(currentUser.uid,'profile',profile);
    if(db && currentUser.uid!=="local"){
      await setDoc(doc(db,"users",currentUser.uid,"profile","default"), profile, { merge:true });
    }
  }
  async function saveProgress(progress){
    LS.set(currentUser.uid,'progress',progress);
    if(db && currentUser.uid!=="local"){
      await setDoc(doc(db,"users",currentUser.uid,"progress","current"), progress, { merge:true });
    }
  }

</script>
</body>
</html>
