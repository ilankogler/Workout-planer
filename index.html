<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Half Marathon Planner ‚Äî Diagnostic</title>
<style>
  :root{
    --easy:#a8e6a3; --speed:#87ceeb; --long:#ffcc80; --race:#ff9999; --rest:#cccccc; --runwalk:#b3a2c7; --walk:#f4cccc;
    --bg:#0f1115; --card:#171923; --text:#e9edf1; --muted:#a0aec0; --accent:#52c7ea; --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;backdrop-filter:blur(8px);background:rgba(15,17,21,.85);padding:12px 16px;border-bottom:1px solid #2d3748;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:10px}
  h1{margin:0;font-size:18px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,button,input,textarea{background:#1f2330;color:var(--text);border:1px solid #2d3748;border-radius:10px;padding:10px 12px;font-size:14px}
  button.primary{background:var(--accent);color:#00202a;border:none}
  button.ghost{background:transparent;border:1px solid #2d3748}
  .badge{font-size:12px;color:var(--muted)}
  .banner{padding:10px 16px;background:#1f2330;border-bottom:1px solid #2d3748;color:var(--muted)}
  .progress{margin:12px 16px;background:#1f2330;border-radius:12px;padding:12px}
  .bar-wrap{height:10px;background:#2d3748;border-radius:8px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg,#52c7ea,#8be9fd);transition:width .3s ease}
  .statline{display:flex;justify-content:space-between;font-size:13px;color:var(--muted);margin-top:8px}
  .list{display:grid;gap:10px;padding:10px 16px 120px}
  .card{background:var(--card);border:1px solid #2d3748;padding:12px;border-radius:12px;display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center}
  .meta{font-size:12px;color:var(--muted)} .workout{font-weight:600}
  .pill{font-size:11px;padding:4px 8px;border-radius:999px;color:#0b0e10;width:max-content}
  .type-e{background:var(--easy)} .type-s{background:var(--speed)} .type-l{background:var(--long)}
  .type-race{background:var(--race)} .type-rest{background:var(--rest)} .type-runwalk{background:var(--runwalk);color:#191919} .type-walk{background:var(--walk);color:#191919}
  input[type=checkbox]{width:22px;height:22px;accent-color:#52c7ea}
  details{grid-column:1 / -1}
  textarea,input.note{width:100%;background:#0f1115;color:#e9edf1;border:1px solid #2d3748;border-radius:8px;padding:8px;font-size:14px}
  footer.fixed{position:fixed;bottom:0;left:0;right:0;background:rgba(15,17,21,.95);border-top:1px solid #2d3748;padding:10px 16px;display:flex;gap:8px;flex-wrap:wrap}
  .next{background:#12202a;border:1px solid #244b57;border-radius:12px;padding:10px 12px;margin:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .next strong{color:#9be7ff}
  .hidden{display:none !important}

  /* Login gate */
  .gate{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
  .panel{width:min(520px,94vw);background:#0f1115;border:1px solid #2d3748;border-radius:16px;padding:20px;display:grid;gap:12px}
  .note{color:#a0aec0;font-size:12px}
  .stack{display:grid;gap:8px}

  /* Anonymous badge tooltip */
  .userline{display:flex;align-items:center;gap:8px}
  .anon-dot{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:999px;background:var(--danger);color:#0b0e10;font-weight:700;font-size:12px;cursor:help;position:relative}
  .anon-tip{position:absolute;top:120%;left:50%;transform:translateX(-50%);background:#2a0f0f;color:#ffdada;border:1px solid #ff9a9a;border-radius:8px;padding:8px 10px;width:260px;font-size:12px;line-height:1.3;box-shadow:0 6px 18px rgba(0,0,0,.35);opacity:0;pointer-events:none;transition:opacity .15s}
  .anon-dot:hover .anon-tip{opacity:1;pointer-events:auto}
  .anon-dot:focus .anon-tip{opacity:1;pointer-events:auto}

  /* Debug panel */
  #debugPanel{position:fixed;right:10px;top:10px;z-index:9999;background:#0b1320;border:1px solid #2b3857;border-radius:12px;max-width:min(92vw,420px);color:#d3e1ff}
  #debugHead{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #2b3857}
  #debugBody{padding:8px 10px;max-height:50vh;overflow:auto}
  #debugToggle{background:#192642;border:1px solid #2b3857;border-radius:8px;padding:4px 8px;color:#d3e1ff}
  pre{white-space:pre-wrap;word-break:break-word;margin:0;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px}
</style>
</head>
<body>

<!-- ---------- DEBUG PANEL ---------- -->
<div id="debugPanel">
  <div id="debugHead">
    <strong>Diagnostics</strong>
    <button id="debugToggle">Hide</button>
  </div>
  <div id="debugBody">
    <pre id="debugText">Booting‚Ä¶</pre>
  </div>
</div>

<!-- ---------- LOGIN GATE ---------- -->
<section id="loginGate" class="gate">
  <div class="panel">
    <h2 style="margin:0 0 6px 0;">Welcome üëã</h2>
    <p class="note" style="margin-top:0">Sign in to create and sync your plan. Your data is saved to your account.</p>

    <div class="stack">
      <button id="loginGoogle" class="primary">Continue with Google</button>
      <div style="height:1px;background:#2d3748;margin:8px 0"></div>
      <button id="continueAnon" class="ghost">Continue without login (Temporary)</button>
      <div class="note">‚ö†Ô∏è <strong>Temporary account:</strong> your data may be lost if you don‚Äôt sign in with Google later.</div>
    </div>

    <div id="loginMsg" class="note"></div>
  </div>
</section>

<!-- ---------- APP (hidden until signed in) ---------- -->
<header id="appHeader" class="hidden">
  <div class="userline">
    <h1 style="margin-right:8px;">Half Marathon Planner</h1>
    <span class="badge" id="userBadge">User</span>
    <span id="anonBadge" class="anon-dot hidden" tabindex="0" aria-label="Anonymous account">?</span>
  </div>
  <div class="controls">
    <select id="weekFilter"></select>
    <button id="showAll" class="ghost">Show all</button>
    <button id="markWeek" class="primary">Mark week done</button>
    <button id="resetPlan" class="ghost">Reset & Replan</button>
    <button id="signout" class="ghost hidden">Sign out</button>
  </div>
</header>

<div id="banner" class="banner hidden"></div>

<section id="nextBox" class="next hidden">
  <div id="nextText">Next workout:</div>
  <button id="markNext" class="primary">Mark next as done</button>
</section>

<section class="progress hidden" id="progressWrap">
  <div class="bar-wrap"><div class="bar" id="bar"></div></div>
  <div class="statline">
    <div><span id="doneCount">0</span>/<span id="totalCount">0</span> completed</div>
    <div id="percent">0%</div>
  </div>
</section>

<main class="list hidden" id="list"></main>

<footer class="fixed hidden" id="footer">
  <button id="export" class="primary">Export progress</button>
  <input id="importFile" type="file" accept="application/json"/>
  <button id="importBtn">Import</button>
  <button id="installBtn">Add to Home</button>
</footer>

<!-- Onboarding Modal -->
<div class="modal hidden" id="onboardModal" role="dialog" aria-modal="true" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(4,8,12,.65);z-index:100;">
  <div class="sheet" style="width:min(680px,94vw);max-height:90vh;overflow:auto;background:#0f1115;border:1px solid #2d3748;border-radius:16px;padding:16px">
    <h2 style="margin:0 0 8px 0;">Let‚Äôs customize your plan</h2>
    <p style="margin-top:0;color:var(--muted)">You can change this anytime.</p>
    <div class="grid" style="display:grid;gap:10px">
      <div class="row">
        <label>Longest distance you can run today (km)</label>
        <input id="q_longest" type="number" min="0" step="0.1" placeholder="e.g., 3">
      </div>
      <div class="row">
        <label>Current 3 km time (mm:ss)</label>
        <input id="q_3k" type="text" placeholder="e.g., 18:00">
      </div>
      <div class="row">
        <label>Your goal</label>
        <select id="q_goal">
          <option value="health">General health / casual</option>
          <option value="distance">Run a specific distance</option>
          <option value="time">Run a distance under a target time</option>
        </select>
      </div>
      <div class="grid two" id="goalExtra" style="display:none;grid-template-columns:1fr 1fr;gap:10px">
        <div class="row">
          <label>Target distance (km)</label>
          <input id="q_target_km" type="number" step="0.1" placeholder="e.g., 21.1">
        </div>
        <div class="row">
          <label>Target time (hh:mm:ss) ‚Äî optional unless time goal</label>
          <input id="q_target_time" type="text" placeholder="e.g., 01:59:00">
        </div>
        <div class="row" style="grid-column:1/-1;">
          <label>Target date (optional)</label>
          <input id="q_target_date" type="date">
        </div>
      </div>
      <div class="row">
        <label>Start date</label>
        <input id="q_start" type="date">
      </div>
      <div class="row">
        <label>Run days per week</label>
        <select id="q_days">
          <option value="3">3</option>
          <option value="4" selected>4</option>
        </select>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:6px;">
        <button id="cancelOnboard" class="ghost">Cancel</button>
        <button id="saveOnboard" class="primary">Create my plan</button>
      </div>
    </div>
  </div>
</div>

<!-- ========== Firebase + App Code (Diagnostic build) ========== -->
<script type="module">
  const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCsk8uKyjaRUVih6HGUsPpwSUX_VI4bZwk",
  authDomain: "workout-planer-cd10f.firebaseapp.com",
  projectId: "workout-planer-cd10f",
  storageBucket: "workout-planer-cd10f.firebasestorage.app",
  messagingSenderId: "450896422196",
  appId: "1:450896422196:web:0b3f45b17b62881ee9f161"
  };
  const HAS_CONFIG = FIREBASE_CONFIG.apiKey && !FIREBASE_CONFIG.apiKey.startsWith("YOUR_");

  /********** Firebase (modular) **********/
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, setPersistence, browserLocalPersistence,
    GoogleAuthProvider, signInWithRedirect, getRedirectResult,
    onAuthStateChanged, signOut, signInAnonymously, linkWithPopup
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  /********** UI refs **********/
  const loginGate = document.getElementById('loginGate');
  const loginGoogle = document.getElementById('loginGoogle');
  const continueAnon = document.getElementById('continueAnon');
  const loginMsg = document.getElementById('loginMsg');

  const appHeader = document.getElementById('appHeader');
  const banner = document.getElementById('banner');
  const nextBox = document.getElementById('nextBox');
  const nextText = document.getElementById('nextText');
  const markNext = document.getElementById('markNext');
  const progressWrap = document.getElementById('progressWrap');
  const list = document.getElementById('list');
  const footer = document.getElementById('footer');
  const userBadge = document.getElementById('userBadge');
  const anonBadge = document.getElementById('anonBadge');
  const signoutBtn = document.getElementById('signout');

  const weekFilter = document.getElementById('weekFilter');
  const showAll = document.getElementById('showAll');
  const markWeek = document.getElementById('markWeek');
  const resetPlan = document.getElementById('resetPlan');
  const exportBtn = document.getElementById('export');
  const importBtn = document.getElementById('importBtn');
  const importFile = document.getElementById('importFile');
  const installBtn = document.getElementById('installBtn');

  /********** Debug panel **********/
  const debugText = document.getElementById('debugText');
  const debugToggle = document.getElementById('debugToggle');
  const debugBody = document.getElementById('debugBody');
  debugToggle.onclick = ()=>{ const hide = debugBody.style.display!=='none'; debugBody.style.display = hide?'none':''; debugToggle.textContent = hide?'Show':'Hide'; };
  function logDebug(obj){ debugText.textContent = JSON.stringify(obj, null, 2); }

  /********** Helpers **********/
  const LS = { key:(uid,k)=>`hmx_${uid}_${k}`, get:(uid,k)=>{try{return JSON.parse(localStorage.getItem(LS.key(uid,k)))}catch{return null}}, set:(uid,k,v)=>localStorage.setItem(LS.key(uid,k), JSON.stringify(v)) };
  function showAppUI(show){ [appHeader, progressWrap, list, footer].forEach(el=>el.classList.toggle('hidden', !show)); loginGate.classList.toggle('hidden', show); }
  function setMsg(el, msg){ if(el) el.textContent = msg || ""; }

  /********** Global state **********/
  let auth=null, db=null, currentUser=null, lastRedirect = null, listenerFired=false, uiSwitched=false;

  /********** Boot **********/
  const bootInfo = { host: location.host, HAS_CONFIG, projectId: FIREBASE_CONFIG.projectId };
  try {
    if (!HAS_CONFIG) {
      banner.classList.remove('hidden');
      banner.textContent = "Firebase config missing ‚Äî please add your config in the HTML.";
      loginGoogle.disabled = true;
      continueAnon.disabled = true;
      logDebug({ ...bootInfo, status: "NO_CONFIG" });
    } else {
      const app = getApps().length ? getApp() : initializeApp(FIREBASE_CONFIG);
      auth = getAuth(app);
      db = getFirestore(app);
      await setPersistence(auth, browserLocalPersistence); // ensure redirect session survives

      // 1) Auth listener FIRST
      onAuthStateChanged(auth, async (user)=>{
        listenerFired = true;
        currentUser = user ? { uid:user.uid, displayName:user.displayName || user.email || "User", isAnonymous: !!user.isAnonymous } : null;

        logDebug({ ...bootInfo, listenerFired, lastRedirect, user: currentUser, uiSwitched });
        if (user && !uiSwitched) {
          uiSwitched = true;
          userBadge.textContent = currentUser.displayName;
          if (currentUser.isAnonymous) {
            anonBadge.innerHTML = '?<span class="anon-tip">Temporary account: your data may be lost if you don‚Äôt sign in with Google later. You can upgrade anytime.</span>';
            anonBadge.classList.remove('hidden');
            anonBadge.onclick = (e)=>{ const tip = anonBadge.querySelector('.anon-tip'); tip.style.opacity = tip.style.opacity==='1'?'0':'1'; tip.style.pointerEvents = tip.style.pointerEvents==='auto'?'none':'auto'; e.stopPropagation(); };
            document.body.addEventListener('click', ()=>{ const tip = anonBadge.querySelector('.anon-tip'); if(tip){ tip.style.opacity='0'; tip.style.pointerEvents='none'; }});
          } else {
            anonBadge.classList.add('hidden');
          }
          try { await enterApp(true); }
          catch(e){ setMsg(loginMsg, "Render error: " + (e.message||e)); }
        }
        if (!user) {
          showAppUI(false);
          setMsg(loginMsg, "Sign in with Google, or continue temporarily.");
        }
        logDebug({ ...bootInfo, listenerFired, lastRedirect, user: currentUser, uiSwitched });
      });

      // 2) Then process the redirect result (surface any error visibly)
      const google = new GoogleAuthProvider(); google.setCustomParameters({ prompt:'select_account' });
      try {
        const rr = await getRedirectResult(auth);
        lastRedirect = rr ? { ok:true, user: !!rr.user, providerId: rr?._tokenResponse?.providerId || null } : { ok:true, user:false };
      } catch (e) {
        lastRedirect = { ok:false, error: (e && (e.message || String(e))) };
        setMsg(loginMsg, `Auth error after redirect: ${e.message || e}`);
      }
      logDebug({ ...bootInfo, listenerFired, lastRedirect, user: currentUser, uiSwitched });

      // 3) Buttons
      if (!loginGoogle.__bound){ loginGoogle.__bound = true; loginGoogle.onclick = ()=>{ setMsg(loginMsg, "Redirecting to Google‚Ä¶"); signInWithRedirect(auth, google); }; }
      if (!continueAnon.__bound){ continueAnon.__bound = true; continueAnon.onclick = async ()=>{ try { await signInAnonymously(auth); } catch(e){ setMsg(loginMsg, "Anonymous sign-in failed: " + (e.message||e)); } }; }
      if (!signoutBtn.__bound){ signoutBtn.__bound = true; signoutBtn.onclick = async ()=>{ await signOut(auth); location.reload(); }; }
    }
  } catch (e) {
    setMsg(loginMsg, "Fatal init error: " + (e.message||e));
    logDebug({ ...bootInfo, fatal: (e && (e.message || String(e))) });
  }

  /********** App logic **********/
  async function enterApp(isAuthed){
    showAppUI(true);
    let profile = LS.get(auth.currentUser.uid,'profile');
    let progress = LS.get(auth.currentUser.uid,'progress') || {};

    if (db && isAuthed) {
      try{
        const profSnap = await getDoc(doc(db,"users",auth.currentUser.uid,"profile","default"));
        if (profSnap.exists()) { profile = profSnap.data(); LS.set(auth.currentUser.uid,'profile',profile); }
        const progSnap = await getDoc(doc(db,"users",auth.currentUser.uid,"progress","current"));
        if (progSnap.exists()) { progress = progSnap.data(); LS.set(auth.currentUser.uid,'progress',progress); }
      }catch(e){
        setMsg(loginMsg, `Firestore load error: ${e.message || e}`);
      }
    }

    if (!profile) { openOnboarding(); }
    else { await buildPlanAndRender(profile, progress); }
  }

  function parseTimeToMinutes(str){ if(!str) return null; const p=str.split(":").map(x=>parseInt(x,10)); if(p.length===3) return p[0]*60+p[1]+p[2]/60; if(p.length===2) return p[0]+p[1]/60; return parseFloat(p[0]); }
  const round1 = x => Math.round(x*10)/10;
  const formatDate = d => d.toISOString().slice(0,10);
  function typeFromText(t){ if(t.startsWith("E:"))return"e"; if(t.startsWith("S:"))return"s"; if(t.startsWith("L:"))return"l"; if(t.includes("Race"))return"race"; if(t.includes("Rest"))return"rest"; if(t.includes("Run/Walk"))return"runwalk"; if(t.includes("Walk"))return"walk"; return"e"; }

  async function callPlannerAI(profile){ return generatePlan(profile); } // stub
  function generatePlan(profile){
    const startDate = new Date(profile.startDate);
    const runDays = (profile.daysPerWeek||4)==4?["Mon","Wed","Sat","Sun"]:["Tue","Thu","Sat"];
    const items = [];
    const start3kMin = parseTimeToMinutes(profile.recent3k) || 18;
    const baseLongest = Math.max(2.5, parseFloat(profile.longestKm||3));
    const needFoundation = baseLongest < 4 || start3kMin >= 18;
    const foundationWeeks = needFoundation ? 4 : 0;

    let anchor = new Date(startDate);
    const dayOffsets = { "Mon":0,"Tue":1,"Wed":2,"Thu":3,"Fri":4,"Sat":5,"Sun":6 };

    for(let w=0; w<foundationWeeks; w++){
      const long = baseLongest + w*0.5 + 0.5;
      const sessions = [
        `E: ${round1(Math.max(2.5, baseLongest + w*0.5))} km`,
        `Run/Walk 5√ó(2‚Äì3 min run / 1 min walk)`,
        `L: ${round1(long)} km`,
        `Walk 30‚Äì40 min`
      ];
      const weekNum = w - (foundationWeeks-1);
      runDays.slice(0,sessions.length).forEach((day,i)=>{
        const d = new Date(anchor); d.setDate(anchor.getDate()+dayOffsets[day]);
        items.push({ week: weekNum, day, date: formatDate(d), workout: sessions[i] });
      });
      anchor.setDate(anchor.getDate()+7);
    }

    let totalWeeks = 16;
    if(profile.goalType!=="health" && profile.targetDate){
      const tdate = new Date(profile.targetDate);
      const diffWeeks = Math.max(8, Math.round((tdate - startDate)/(1000*60*60*24*7)));
      totalWeeks = Math.min(24, Math.max(12, diffWeeks));
    }

    let e=3, l=4, sp=0;
    const speedMenu = ["S: 4√ó400m fast / 400m jog","S: 5√ó400m","S: 4√ó600m","S: 6√ó400m","S: 5√ó600m","S: 6√ó500m","S: 4√ó800m","S: 5√ó800m","S: 6√ó800m","S: 5√ó1 km","S: 6√ó1 km","S: 8√ó600m"];
    for(let w=1; w<=totalWeeks; w++){
      const S = speedMenu[Math.min(sp, speedMenu.length-1)];
      if(w%1===0) e += (w%2===0?0.5:0);
      if(w>1 && w<=14) l += (w%2===0?1:0);
      const sessions = [
        `E: ${round1(e)} km`,
        S,
        `L: ${Math.min(round1(l), profile.goalKm?Math.max(12, profile.goalKm*0.85):18)} km`,
        `E: ${round1(Math.max(3, e-1))} km`
      ];
      runDays.forEach((day,i)=>{
        const d = new Date(anchor); d.setDate(anchor.getDate()+dayOffsets[day]);
        items.push({ week: w, day, date: formatDate(d), workout: sessions[i] || "Rest" });
      });
      anchor.setDate(anchor.getDate()+7); sp++;
    }

    return { items, runDays };
  }

  async function buildPlanAndRender(profile, progress){
    if(!profile){ openOnboarding(); return; }
    const plan = await callPlannerAI(profile);
    renderList(plan, progress || {});
  }

  function renderList(plan, progress){
    const PLAN = plan;
    list.innerHTML = "";
    const state = progress || {};
    const weeks = [...new Set(PLAN.items.map(i=>i.week))].sort((a,b)=>a-b);
    weekFilter.innerHTML = weeks.map(w=>`<option value="${w}">Week ${w}</option>`).join("");
    if(state.filterWeek==null) state.filterWeek = weeks[0];
    weekFilter.value = state.filterWeek;

    const today = new Date().toISOString().slice(0,10);
    const next = PLAN.items.find((it, idx)=>!state['w'+idx] && it.date >= today);
    if(next){
      nextBox.classList.remove('hidden');
      nextText.innerHTML = `Next workout: <strong>${next.workout}</strong> ‚Ä¢ ${next.day} ‚Ä¢ ${next.date}`;
      markNext.onclick = ()=>{ const idx = PLAN.items.indexOf(next); state['w'+idx]=true; saveProgress(state); updateProgress(state, PLAN); renderList(PLAN, state); };
    } else { nextBox.classList.add('hidden'); }

    PLAN.items.forEach((it, idx)=>{
      const show = (state.filterWeek==null || it.week == state.filterWeek);
      const card = document.createElement('div'); card.className='card'; if(!show) card.style.display='none';
      const id = "w"+idx;

      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=!!state[id];
      cb.addEventListener('change', ()=>{ state[id]=cb.checked; saveProgress(state); updateProgress(state, PLAN); });

      const content = document.createElement('div');
      const wline = document.createElement('div'); wline.className='workout'; wline.textContent=it.workout;
      const meta = document.createElement('div'); meta.className='meta'; meta.textContent = `Week ${it.week} ‚Ä¢ ${it.day} ‚Ä¢ ${it.date}`;
      const pill = document.createElement('span'); const typ=typeFromText(it.workout); pill.className='pill type-'+typ; pill.textContent=typ.toUpperCase();

      const details = document.createElement('details'); const summary = document.createElement('summary'); summary.textContent='Add notes';
      const fields = document.createElement('div'); fields.innerHTML = `
        <div style="display:grid;gap:8px;margin-top:8px;">
          <input class="note" id="time_${id}" placeholder="Time (min)" inputmode="decimal">
          <input class="note" id="dist_${id}" placeholder="Distance (km)" inputmode="decimal">
          <input class="note" id="hr_${id}" placeholder="Avg HR">
          <textarea class="note" id="notes_${id}" rows="2" placeholder="Notes"></textarea>
        </div>`;
      ["time_","dist_","hr_","notes_"].forEach(k=>{
        const el = fields.querySelector("#"+k+id);
        if(state[k+id]) el.value = state[k+id];
        el.addEventListener('input', ()=>{ state[k+id]=el.value; saveProgress(state); });
      });

      details.appendChild(summary); details.appendChild(fields);
      content.appendChild(wline); content.appendChild(meta); content.appendChild(pill); content.appendChild(details);
      card.appendChild(cb); card.appendChild(content);
      list.appendChild(card);
    });

    updateProgress(state, PLAN);
    hookControls(state, PLAN);
    [appHeader, progressWrap, list, footer].forEach(el=>el.classList.remove('hidden'));
  }

  function updateProgress(state, PLAN){
    let done=0; PLAN.items.forEach((_, idx)=>{ if(state['w'+idx]) done++; });
    const total = PLAN.items.length; const pct = total? Math.round(done*100/total) : 0;
    document.getElementById('doneCount').textContent = done;
    document.getElementById('percent').textContent = pct + "%";
    document.getElementById('bar').style.width = pct + "%";
  }

  function hookControls(state, PLAN){
    weekFilter.onchange = e=>{ state.filterWeek=parseInt(e.target.value); saveProgress(state); renderList(PLAN, state); };
    showAll.onclick = ()=>{ state.filterWeek=null; saveProgress(state); renderList(PLAN, state); };
    markWeek.onclick = ()=>{ if(state.filterWeek==null) return; PLAN.items.forEach((it, idx)=>{ if (it.week===state.filterWeek) state['w'+idx]=true; }); saveProgress(state); renderList(PLAN, state); };
    resetPlan.onclick = ()=> openOnboarding(true);

    exportBtn.onclick = ()=>{
      const uid = auth?.currentUser?.uid || "local";
      const blob = new Blob([JSON.stringify({profile:LS.get(uid,'profile'), progress:LS.get(uid,'progress')}, null, 2)], {type:"application/json"});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='hm_backup.json'; a.click();
    };
    importBtn.onclick = ()=>{
      const f = importFile.files[0]; if(!f) return;
      const r = new FileReader(); r.onload = async ()=>{
        try{
          const o = JSON.parse(r.result);
          const uid = auth?.currentUser?.uid || "local";
          if(o.profile){ await saveProfile(o.profile); }
          if(o.progress){ await saveProgress(o.progress); }
          await buildPlanAndRender(o.profile||LS.get(uid,'profile'), o.progress||LS.get(uid,'progress'));
        }catch{ alert('Invalid file'); }
      }; r.readAsText(f);
    };

    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.disabled=false; });
    installBtn.onclick = async ()=>{ if(!deferredPrompt){ alert('Use Share ‚Üí Add to Home Screen'); return; } deferredPrompt.prompt(); deferredPrompt=null; };
  }

  function openOnboarding(isReset=false){
    const m = document.getElementById('onboardModal'); m.classList.remove('hidden');
    const qgoal = document.getElementById('q_goal'); const extra = document.getElementById('goalExtra');
    qgoal.onchange = ()=>{ extra.style.display = (qgoal.value==="distance"||qgoal.value==="time")?"grid":"none"; };
    const start = document.getElementById('q_start'); if(!start.value){ start.value = new Date().toISOString().slice(0,10); }
    document.getElementById('cancelOnboard').onclick = ()=>{ if(isReset){ m.classList.add('hidden'); } else { alert('Please complete setup to continue.'); } };
    document.getElementById('saveOnboard').onclick = async ()=>{
      const p = {
        longestKm: parseFloat(document.getElementById('q_longest').value||"3"),
        recent3k: document.getElementById('q_3k').value||"18:00",
        goalType: qgoal.value,
        targetKm: parseFloat(document.getElementById('q_target_km').value||"0"),
        targetTime: document.getElementById('q_target_time').value||"",
        targetDate: document.getElementById('q_target_date').value||"",
        startDate: document.getElementById('q_start').value || new Date().toISOString().slice(0,10),
        daysPerWeek: parseInt(document.getElementById('q_days').value||"4",10),
      };
      if(p.goalType!=="health"){ p.goalKm = p.targetKm || 21.1; } else { p.goalKm = null; }
      await saveProfile(p);
      document.getElementById('onboardModal').classList.add('hidden');
      await buildPlanAndRender(p, LS.get(auth.currentUser.uid,'progress')||{});
    };
  }

  async function saveProfile(profile){
    const uid = auth.currentUser.uid;
    LS.set(uid,'profile',profile);
    if(db){ await setDoc(doc(db,"users",uid,"profile","default"), profile, { merge:true }); }
  }
  async function saveProgress(progress){
    const uid = auth.currentUser.uid;
    LS.set(uid,'progress',progress);
    if(db){ await setDoc(doc(db,"users",uid,"progress","current"), progress, { merge:true }); }
  }

  // Optional: helper to upgrade anon ‚Üí Google while preserving data
  window.upgradeToGoogle = async function(){
    try{
      const provider = new GoogleAuthProvider();
      await linkWithPopup(auth.currentUser, provider);
      alert("Account linked to Google. Your data is now permanent.");
      location.reload();
    }catch(e){
      alert("Link failed: " + (e.message||e));
    }
  };
</script>

</body>
</html>
